ARG ONGGI_IMAGE=c.rzp.io/razorpay/onggi:php-8.1-nginx

FROM $ONGGI_IMAGE as opencensus-ext

WORKDIR /

ARG OPENCENSUS_VERSION_TAG=v0.8.0-beta


RUN set -eux && \
    wget -O - https://github.com/razorpay/opencensus-php/tarball/"${OPENCENSUS_VERSION_TAG}" | tar xz --strip=1

RUN cd /ext && phpize81 && ./configure --enable-opencensus --with-php-config=/usr/bin/php-config81 && make install

FROM $ONGGI_IMAGE

RUN pip install --no-cache-dir "razorpay.alohomora==0.5.0"

ARG GIT_COMMIT_HASH
ENV GIT_COMMIT_HASH=${GIT_COMMIT_HASH}

VOLUME ['/app']

RUN pear81 config-set php_ini /etc/php81/php.ini && \
    pecl81 install opencensus-alpha

COPY --from=opencensus-ext /usr/lib/php81/modules/opencensus.so /usr/lib/php81/modules

COPY ./dockerconf/entrypoint.sh /entrypoint.sh

WORKDIR /app

RUN chown -R nginx.nginx /app

EXPOSE 80

ENTRYPOINT ["/entrypoint.sh"]
